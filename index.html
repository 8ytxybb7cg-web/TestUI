<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex, nofollow">
  <title>Travel Sync Ultimate (v7.3)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    :root {
      --ios-bg: #F2F2F7;
      --ios-primary: #007AFF;
      --glass-blur: blur(25px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    }

    body {
      background-color: var(--ios-bg);
      font-family: var(--font-stack);
      margin: 0; color: #000; overflow: hidden; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* 1. Background Image Layer */
    .bg-layer {
        position: fixed; inset: 0; z-index: -1;
    }
    .bg-layer img {
        width: 100%; height: 100%; object-fit: cover;
        opacity: 0.25; /* 調整此數值改變淡入程度 (0.1 - 0.5) */
    }
    .bg-layer-overlay {
        position: absolute; inset: 0;
        background: rgba(242, 242, 247, 0.5); /* 淺色遮罩增加朦朧感 */
        backdrop-filter: blur(3px);
    }

    #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; position: relative; }

    main {
        flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        padding-bottom: 120px; padding-top: 130px;
    }

    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Cards */
    .ios-card {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03); overflow: hidden;
    }

    /* Dark Glass (Expense) */
    .ios-card-dark-glass {
      background: rgba(22, 22, 24, 0.85);
      backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 24px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      color: white; position: relative; overflow: hidden;
    }
    .dark-glass-gradient {
        position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%);
        pointer-events: none; z-index: 0;
    }

    /* List Items */
    .ios-list-item {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px); border-radius: 18px;
      margin-bottom: 8px; padding: 14px;
      display: flex; align-items: center; justify-content: space-between;
      border: 1px solid rgba(255,255,255,0.5);
    }
    
    /* Inputs */
    .ios-input {
      background: rgba(118, 118, 128, 0.12); border: none; border-radius: 10px;
      padding: 10px 12px; font-size: 16px; color: #000; width: 100%; box-sizing: border-box;
    }

    /* Modal */
    .modal-backdrop { 
      background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);
      z-index: 100; position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; padding: 16px;
    }
    .ios-modal-container {
      background: rgba(250, 250, 250, 0.95); backdrop-filter: blur(40px);
      border-radius: 32px; display: flex; flex-direction: column; max-height: 90vh; width: 100%; max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.4);
    }
    .ios-modal-header { padding: 16px; text-align: center; font-weight: 600; font-size: 17px; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
    .ios-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .ios-modal-footer { padding: 16px 20px; border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; gap: 12px; background: rgba(255,255,255,0.5); }
    
    .btn-ios-cancel { flex: 1; height: 44px; border-radius: 12px; background: rgba(118, 118, 128, 0.12); color: #000; font-weight: 600; }
    .btn-ios-primary { flex: 1; height: 44px; border-radius: 12px; background: var(--ios-primary); color: white; font-weight: 600; }
    .btn-ios-danger { flex: 1; height: 44px; border-radius: 12px; background: #FF3B30; color: white; font-weight: 600; }

    /* Calculator Grid */
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
    .calc-btn { border-radius: 10px; background: white; font-size: 20px; font-weight: 500; color: #333; height: 44px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .calc-btn.op { background: #FF9500; color: white; font-weight: 600; }

    /* Dock */
    .iphone-dock {
      background: rgba(245, 245, 245, 0.85);
      backdrop-filter: blur(50px);
      border-radius: 38px; padding: 12px 24px; border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      display: flex; justify-content: space-between; align-items: flex-end;
      width: 100%; max-width: 360px; margin: 0 auto;
    }

    /* Toast */
    .toast-notification {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8); color: white; padding: 16px 32px; border-radius: 12px;
        z-index: 200; font-weight: 600; backdrop-filter: blur(10px);
        animation: fadeOut 2s forwards; pointer-events: none;
    }
    @keyframes fadeOut { 0% { opacity: 1; } 70% { opacity: 1; } 100% { opacity: 0; } }

    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;
    const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi';
    const TRIP_ID = 'travel_sync_ultimate_v1';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    createApp({
      setup() {
        const appVersion = ref('v7.3');
        const currentTab = ref('首頁');
        const syncState = ref('loading');
        const isInitialized = ref(false);
        const lang = ref(localStorage.getItem('app_lang') || 'zh');
        const flightCardSkin = ref(localStorage.getItem('flight_skin') || 'ios');
        const rateDisplayMode = ref(0);
        const showToast = ref(false);

        // Data
        const settings = reactive({
            route: 'HKG ✈️ KIX', startDate: '2026-03-22', endDate: '2026-03-27',
            localCurrency: 'TWD', homeCurrency: 'HKD', weatherLoc: 'Taipei', infoText: ''
        });
        // Temp settings for Edit Mode
        const tempSettings = reactive({});

        const itinerary = reactive([[], [], [], [], [], []]); // Dynamic based on days
        const preTripNotes = ref([]);
        const shoppingList = ref([]);
        const expenses = ref([]);
        const members = ref(['Me', 'Partner']);
        const activeFlight = reactive({
            id: 'f1', code: 'CX400', title: 'Cathay Pacific', fromCode: 'HKG', toCode: 'TPE',
            depTime: '10:00', arrTime: '11:50', status: 'On Time', gate: '24', fromTerminal:'1', toTerminal:'1'
        });

        // Modals
        const flightModalOpen = ref(false); const newFlight = reactive({});
        const preNoteModalOpen = ref(false); const editingPreNote = reactive({});
        const shoppingModalOpen = ref(false); const newShoppingItem = reactive({});
        const expenseModalOpen = ref(false); const newExpense = reactive({});
        const itineraryModalOpen = ref(false); const newItineraryItem = reactive({});
        const memberModalOpen = ref(false); const newMemberName = ref('');

        const expenseFilter = ref('all');
        const selectedDay = ref(0);
        const quickItinerary = reactive({ title: '', time: '' });

        // 6. Dynamic Days Logic
        const days = computed(() => {
            if(!settings.startDate || !settings.endDate) return [];
            const start = new Date(settings.startDate);
            const end = new Date(settings.endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
            
            // Adjust itinerary array length if needed (simplified for display)
            return Array.from({length: diffDays}, (_, i) => {
                const d = new Date(start); d.setDate(d.getDate() + i);
                return { 
                    dateStr: d.toLocaleDateString('en-GB', {day:'numeric', month:'short'}), // 22 Mar
                    fullDate: d.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'}), // 22 Mar 2026
                    weekday: d.toLocaleDateString(lang.value === 'zh' ? 'en-GB' : 'en-GB', {weekday:'short'}), // Mon
                    iso: d.toISOString().split('T')[0]
                };
            });
        });

        const sortedItinerary = computed(() => {
            // Ensure itinerary array is big enough
            if (itinerary.length < days.value.length) {
                while(itinerary.length < days.value.length) itinerary.push([]);
            }
            return itinerary[selectedDay.value] || [];
        });

        // 7. i18n
        const t = (k) => {
            const dict = {
                '首頁': { zh: '首頁', en: 'Home' }, '行程': { zh: '行程', en: 'Itinerary' },
                '記帳': { zh: '記帳', en: 'Expense' }, '設定': { zh: '設定', en: 'Settings' },
                'viewAll': { zh: '查看全部', en: 'View All' },
                'prepList': { zh: '準備清單', en: 'Prep List' },
                'shopping': { zh: '購物清單', en: 'Shopping' },
                'expenses': { zh: '支出總覽', en: 'Overview' },
                'info': { zh: '資訊', en: 'Info' },
                'rate': { zh: '即時匯率', en: 'Live Rate' },
                'feeIncluded': { zh: '含3%手續費', en: 'Incl. 3% Fee' },
                'settlement': { zh: '結算中心', en: 'Settlement' },
                'shouldPay': { zh: '需支付', en: 'Pays' },
                'shouldReceive': { zh: '需收取', en: 'Gets' },
                'cancel': { zh: '取消', en: 'Cancel' },
                'save': { zh: '儲存', en: 'Save' },
                'delete': { zh: '刪除', en: 'Delete' },
                'edit': { zh: '編輯', en: 'Edit' },
                'new': { zh: '新增', en: 'New' },
                'saved': { zh: '已儲存', en: 'Saved' },
                // 3. Filters
                'all': { zh: '全部', en: 'All' },
                'credit': { zh: '信用卡', en: 'Card' },
                'cash': { zh: '現金', en: 'Cash' },
                'settle': { zh: '結算', en: 'Settle' },
                // 4. Categories
                'ticket': { zh: '門票', en: 'Tickets' },
                'transport': { zh: '交通', en: 'Transport' },
                'shopping_cat': { zh: '購物', en: 'Shopping' },
                'dining': { zh: '餐飲', en: 'Dining' },
                'entertainment': { zh: '娛樂', en: 'Entertainment' },
                'accommodation': { zh: '住宿', en: 'Accommodation' },
                'service': { zh: '服務', en: 'Service' },
                'other': { zh: '其他', en: 'Other' }
            };
            return dict[k]?.[lang.value] || k;
        };

        // Helper Vars
        const syncStatusText = computed(() => ({ 'synced': '已同步', 'saving': '...', 'loading': '...', 'error': '!' }[syncState.value] || ''));
        const currentLiveRate = ref(4.1);
        
        // 5.09 Logic
        const totalExpense = computed(() => {
            let totalHome = 0;
            expenses.value.forEach(e => {
                let amt = parseFloat(e.amount) || 0;
                let homeAmt = (e.currency === settings.homeCurrency) ? amt : (amt / currentLiveRate.value);
                totalHome += homeAmt;
            });
            return { hkd: totalHome, twd: totalHome * currentLiveRate.value };
        });
        const expensesBreakdown = computed(() => {
            let cardHkd = 0, cashHkd = 0;
            expenses.value.forEach(e => {
                let amt = parseFloat(e.amount) || 0;
                let homeAmt = (e.currency === settings.homeCurrency) ? amt : (amt / currentLiveRate.value);
                if(e.paymentMethod === 'credit_card') cardHkd += homeAmt; else cashHkd += homeAmt;
            });
            return { card: { hkd: cardHkd, twd: cardHkd * currentLiveRate.value }, cash: { hkd: cashHkd, twd: cashHkd * currentLiveRate.value } };
        });
        const filteredExpenses = computed(() => {
            let list = [...expenses.value].sort((a,b) => b.created_at - a.created_at);
            if(expenseFilter.value === 'credit') return list.filter(e => e.paymentMethod === 'credit_card');
            if(expenseFilter.value === 'cash') return list.filter(e => e.paymentMethod === 'cash');
            return list;
        });
        const settlementList = computed(() => {
            const bal = {}; members.value.forEach(m => bal[m] = 0);
            expenses.value.forEach(e => {
                let amt = parseFloat(e.amount) || 0;
                let homeAmt = (e.currency === settings.localCurrency) ? amt / currentLiveRate.value : amt;
                let payer = e.payer || members.value[0];
                bal[payer] = (bal[payer] || 0) + homeAmt;
                let split = homeAmt / members.value.length;
                members.value.forEach(m => bal[m] = (bal[m] || 0) - split);
            });
            return Object.keys(bal).map(k => ({name: k, amount: bal[k]})).filter(x => Math.abs(x.amount) > 1);
        });

        // Methods
        function toggleLang() { lang.value = lang.value === 'zh' ? 'en' : 'zh'; localStorage.setItem('app_lang', lang.value); }
        function toggleSkin() { flightCardSkin.value = flightCardSkin.value === 'ios' ? 'hkg' : 'ios'; localStorage.setItem('flight_skin', flightCardSkin.value); }
        function formatNumber(n) { return Number(n).toLocaleString('en-US', {maximumFractionDigits: 1}); }
        function generateId() { return Date.now() + Math.random().toString(36).substr(2, 5); }

        // Settings Logic
        function enterSettings() { Object.assign(tempSettings, JSON.parse(JSON.stringify(settings))); currentTab.value = '設定'; }
        function cancelSettings() { currentTab.value = '首頁'; }
        function saveSettings() { 
            Object.assign(settings, tempSettings); 
            saveAll(); 
            showToast.value = true; setTimeout(()=>showToast.value=false, 2000);
        }

        // Cloud
        async function fetchCloud() {
            syncState.value = 'loading';
            try {
                const { data } = await supabaseClient.from('trip_data').select('content').eq('id', TRIP_ID).single();
                if(data?.content) {
                    const c = data.content;
                    if(c.settings) Object.assign(settings, c.settings);
                    if(c.itinerary) {
                        // Ensure it fits the array
                        c.itinerary.forEach((d,i) => itinerary[i] = d);
                    }
                    if(c.preTripNotes) preTripNotes.value = c.preTripNotes;
                    if(c.shoppingList) shoppingList.value = c.shoppingList;
                    if(c.expenses) expenses.value = c.expenses;
                    if(c.flight) Object.assign(activeFlight, c.flight);
                    if(c.members) members.value = c.members;
                }
                syncState.value = 'synced'; isInitialized.value = true;
            } catch { syncState.value = 'error'; }
        }
        async function saveAll() {
            if(!isInitialized.value) return;
            syncState.value = 'saving';
            const payload = { settings, itinerary, preTripNotes: preTripNotes.value, shoppingList: shoppingList.value, expenses: expenses.value, flight: activeFlight, members: members.value };
            await supabaseClient.from('trip_data').upsert({ id: TRIP_ID, content: payload, updated_at: new Date() });
            setTimeout(() => syncState.value = 'synced', 800);
        }
        
        // Modal Actions
        function openExpenseModal(item) { 
            Object.assign(newExpense, item || {id:null, amount:'', currency: settings.localCurrency, category:'dining', paymentMethod:'cash', payer: members.value[0]}); 
            expenseModalOpen.value = true; 
        }
        function handleCalcInput(k) { 
            let val = String(newExpense.amount); 
            if(k === 'C') val = ''; 
            else if(k === '=') { try { val = String(eval(val)); } catch{} } 
            else val += k; 
            newExpense.amount = val; 
        }
        function saveExpense() { 
            const item = { ...newExpense, id: newExpense.id || generateId(), created_at: Date.now() }; 
            const idx = expenses.value.findIndex(e => e.id === item.id); 
            if(idx !== -1) expenses.value[idx] = item; else expenses.value.push(item); 
            expenseModalOpen.value = false; saveAll(); 
        }
        function removeExpense(id) { expenses.value = expenses.value.filter(x=>x.id!==id); }
        
        // Standard CRUDs (Simplified)
        function openFlightModal() { Object.assign(newFlight, activeFlight); flightModalOpen.value=true; }
        function saveFlight() { Object.assign(activeFlight, newFlight); flightModalOpen.value=false; saveAll(); }
        function openMemberModal() { memberModalOpen.value=true; }
        function addMember() { if(newMemberName.value && !members.value.includes(newMemberName.value)) { members.value.push(newMemberName.value); newMemberName.value=''; saveAll(); } }
        function removeMember(m) { if(confirm('Remove?')) { members.value = members.value.filter(x=>x!==m); saveAll(); } }
        function openShoppingModal(i) { Object.assign(newShoppingItem, i||{id:null, name:'', isDone:false}); shoppingModalOpen.value=true; }
        function saveShoppingItem() { if(!newShoppingItem.id) shoppingList.value.push({...newShoppingItem, id:generateId()}); else { const idx=shoppingList.value.findIndex(x=>x.id===newShoppingItem.id); shoppingList.value[idx]={...newShoppingItem}; } shoppingModalOpen.value=false; saveAll(); }
        function removeShoppingItem(id) { shoppingList.value=shoppingList.value.filter(x=>x.id!==id); }
        function openItineraryModal(i) { Object.assign(newItineraryItem, i||{id:null, dayIndex:selectedDay.value}); itineraryModalOpen.value=true; }
        function saveItineraryItem() { const t=itinerary[newItineraryItem.dayIndex]; if(!t)return; if(!newItineraryItem.id) t.push({...newItineraryItem, id:generateId()}); else { const idx=t.findIndex(x=>x.id===newItineraryItem.id); t[idx]={...newItineraryItem}; } t.sort((a,b)=>(a.time||'').localeCompare(b.time||'')); itineraryModalOpen.value=false; saveAll(); }
        function removeItineraryItem(id) { itinerary[selectedDay.value]=itinerary[selectedDay.value].filter(x=>x.id!==id); saveAll(); }
        function addQuickItinerary() { itinerary[selectedDay.value].push({id:generateId(), time:quickItinerary.time, title:quickItinerary.title}); itinerary[selectedDay.value].sort((a,b)=>(a.time||'').localeCompare(b.time||'')); quickItinerary.title=''; saveAll(); }
        
        // Init
        onMounted(() => {
            fetchCloud();
            // Sortable init skipped for brevity in Part 1
        });

        return {
            appVersion, currentTab, syncState, syncStatusText, lang, t, toggleLang, showToast,
            settings, tempSettings, itinerary, preTripNotes, shoppingList, expenses, totalExpense, expensesBreakdown,
            activeFlight, flightCardSkin, toggleSkin, openFlightModal, flightModalOpen, newFlight, saveFlight,
            days, selectedDay, sortedItinerary, openItineraryModal, itineraryModalOpen, newItineraryItem, saveItineraryItem, removeItineraryItem, quickItinerary, addQuickItinerary,
            shoppingModalOpen, newShoppingItem, openShoppingModal, saveShoppingItem, removeShoppingItem,
            expenseModalOpen, newExpense, expenseFilter, filteredExpenses, settlementList, openExpenseModal, handleCalcInput, saveExpense, removeExpense,
            memberModalOpen, members, newMemberName, openMemberModal, addMember, removeMember,
            enterSettings, cancelSettings, saveSettings, formatNumber, currentLiveRate
        };
      }
    }).mount('#app');
    });
  </script>
</head>
<body>
  <div id="app">
    <div class="bg-layer">
        <img src="IMG_7005.jpeg" alt="bg">
        <div class="bg-layer-overlay"></div>
    </div>
    
    <div v-if="showToast" class="toast-notification"><i class="ph-bold ph-check"></i> {{ t('saved') }}</div>

    <header class="fixed top-0 left-0 right-0 z-50 pt-12 pb-3 px-6 flex justify-between items-end bg-white/10 backdrop-blur-xl border-b border-white/10 transition-all duration-300">
      <div>
        <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-0.5 font-mono flex items-center gap-2">
           TRAVEL SYNC {{ appVersion }}
           <div class="flex items-center gap-1.5">
               <div class="w-2 h-2 rounded-full transition-all duration-300" :class="{'bg-[#34C759]': syncState === 'synced', 'bg-[#FFCC00] animate-pulse': syncState === 'syncing', 'bg-[#FF3B30]': syncState === 'error'}"></div>
           </div>
        </div>
        <h1 class="text-3xl font-bold text-black tracking-tight flex items-center gap-2">
          {{ settings.route }}
        </h1>
      </div>
      <div class="flex flex-col items-end gap-2">
         <button @click="toggleLang" class="text-[10px] font-bold bg-gray-200/50 text-gray-600 px-2 py-0.5 rounded-md backdrop-blur-md">
            {{ lang === 'zh' ? 'EN' : '繁' }}
         </button>
      </div>
    </header>

    <main class="px-5 space-y-5 relative">
      
      <div v-if="currentTab === '首頁'" class="space-y-5 animate-fade-in">
        
        <div class="relative transition-all duration-500">
            <div class="absolute top-4 left-4 z-30">
               <button @click="toggleSkin" class="glass-btn-high-contrast px-3 py-1.5 rounded-full text-[10px] font-bold bg-black/40 backdrop-blur-md border border-white/20 text-white flex items-center gap-1">
                  {{ flightCardSkin === 'ios' ? 'HKG' : 'iOS' }}
               </button>
            </div>
            <div @click="openFlightModal" class="ios-card-dark-glass p-0 shadow-xl relative min-h-[220px]">
                <div class="dark-glass-gradient"></div>
                <div class="relative z-10 p-6 flex flex-col justify-between h-full">
                    <div class="flex justify-between items-start mt-8">
                       <div class="text-3xl font-bold text-white">{{ activeFlight.code }}</div>
                       <div class="text-white/60 font-medium uppercase">{{ activeFlight.title }}</div>
                    </div>
                    <div class="flex justify-between items-end mt-4">
                        <div>
                            <div class="text-5xl font-bold text-white">{{ activeFlight.fromCode }}</div>
                            <div class="text-white/80 font-mono">{{ activeFlight.depTime }}</div>
                        </div>
                        <div class="pb-2 text-white/50"><i class="ph-fill ph-airplane text-2xl rotate-90"></i></div>
                        <div class="text-right">
                             <div class="text-5xl font-bold text-white">{{ activeFlight.toCode }}</div>
                             <div class="text-white/80 font-mono">{{ activeFlight.arrTime }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="days.length > 0" class="ios-card p-4 flex justify-between items-center">
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">DAY {{ selectedDay + 1 }}</span>
                <span class="text-xl font-bold text-slate-800">{{ days[selectedDay].fullDate }}</span>
            </div>
            <div class="text-xs font-bold bg-gray-100 text-gray-500 px-3 py-1 rounded-full">{{ days[selectedDay].weekday }}</div>
        </div>

        <div class="ios-card p-5">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="ph-fill ph-shopping-bag text-pink-500"></i> {{ t('shopping') }}</h2>
              <button @click="openShoppingModal()" class="w-8 h-8 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center"><i class="ph-bold ph-plus"></i></button>
            </div>
            <div v-for="item in shoppingList" :key="item.id" class="flex items-center justify-between p-3 bg-white/60 rounded-xl border border-white/50 mb-2">
                <span :class="{'line-through text-gray-400': item.isDone}" class="font-medium text-slate-800">{{ item.name }}</span>
                <div class="flex gap-2">
                    <button @click="item.isDone=!item.isDone" class="text-gray-400"><i :class="item.isDone ? 'ph-fill ph-check-circle text-green-500' : 'ph-bold ph-circle'"></i></button>
                    <button @click="removeShoppingItem(item.id)" class="text-gray-300"><i class="ph-bold ph-trash"></i></button>
                </div>
            </div>
        </div>

        <section class="ios-card-dark-glass p-6 relative overflow-hidden group">
            <div class="dark-glass-gradient"></div>
            <button @click="openMemberModal" class="absolute top-4 left-4 w-9 h-9 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center text-white z-20"><i class="ph-bold ph-gear text-lg"></i></button>
            <button @click="openExpenseModal(null)" class="absolute top-4 right-4 w-9 h-9 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center text-white z-20"><i class="ph-bold ph-plus text-lg"></i></button>

            <div class="relative z-10 flex flex-col items-center justify-center mt-2">
                 <div class="text-white/60 text-[11px] font-bold tracking-widest uppercase mb-1">Total ({{ settings.homeCurrency }})</div>
                 <div class="text-4xl font-light tracking-tight text-white flex items-baseline">
                    <span class="text-2xl opacity-60 mr-1">$</span>{{ formatNumber(totalExpense.hkd) }}
                 </div>
                 <div class="text-white/40 text-xs font-medium mt-1">≈ {{ settings.localCurrency }} {{ formatNumber(totalExpense.twd) }}</div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mt-6 relative z-10">
               <div class="bg-white/5 rounded-2xl p-3 backdrop-blur-sm border border-white/5 flex flex-col items-center justify-center text-center">
                    <div class="text-white/50 text-[10px] uppercase tracking-wider mb-1"><i class="ph-fill ph-credit-card mr-1"></i> {{ t('credit') }}</div>
                    <div class="text-lg font-bold text-white mb-0.5">${{ formatNumber(expensesBreakdown.card.hkd) }}</div>
                    <div class="text-[9px] text-white/40">≈ {{ settings.localCurrency }} {{ formatNumber(expensesBreakdown.card.twd) }}</div>
               </div>
               <div class="bg-white/5 rounded-2xl p-3 backdrop-blur-sm border border-white/5 flex flex-col items-center justify-center text-center">
                   <div class="text-white/50 text-[10px] uppercase tracking-wider mb-1"><i class="ph-fill ph-coins mr-1"></i> {{ t('cash') }}</div>
                   <div class="text-lg font-bold text-white mb-0.5">${{ formatNumber(expensesBreakdown.cash.hkd) }}</div>
                   <div class="text-[9px] text-white/40">≈ {{ settings.localCurrency }} {{ formatNumber(expensesBreakdown.cash.twd) }}</div>
               </div>
            </div>
        </section>

        <section class="ios-card p-5 bg-blue-50/50 border-blue-100 mb-6">
             <h2 class="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2"><i class="ph-fill ph-info"></i> {{ t('info') }}</h2>
             <p class="text-xs text-blue-900/70 leading-relaxed whitespace-pre-line">{{ settings.infoText || 'No info set.' }}</p>
        </section>
      </div>

      <div v-if="currentTab === '行程'" class="space-y-4 animate-fade-in pb-20">
         <div class="flex justify-between gap-2 overflow-x-auto no-scrollbar py-2">
            <button v-for="(d, i) in days" :key="i" @click="selectedDay = i" 
              class="flex-shrink-0 w-[22%] h-[70px] rounded-xl flex flex-col items-center justify-center border transition-all"
              :class="selectedDay === i ? 'bg-white border-blue-400 shadow-sm' : 'bg-white/40 border-transparent'">
              <span class="text-[10px] font-bold uppercase text-gray-400">DAY {{ i + 1 }}</span>
              <span class="text-[9px] font-medium text-gray-500">{{ d.weekday }}</span>
              <span class="text-lg font-bold text-slate-800 leading-none mt-0.5">{{ d.dateStr }}</span>
            </button>
         </div>
         <div class="space-y-3">
             <div v-for="it in sortedItinerary" :key="it.id" @click="openItineraryModal(it)" class="ios-card p-3 relative active:scale-[0.99] transition-transform">
                 <div class="flex items-start gap-3">
                     <div class="flex-1">
                         <div class="flex justify-between"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">{{ it.time }}</span></div>
                         <div class="font-bold text-[16px] text-gray-900 mt-1">{{ it.title }}</div>
                     </div>
                     <button @click.stop="removeItineraryItem(it.id)" class="text-gray-300 hover:text-red-500"><i class="ph ph-trash"></i></button>
                 </div>
             </div>
             <div v-if="sortedItinerary.length === 0" class="text-center text-gray-400 text-sm py-4">No activities</div>
         </div>
         <div class="ios-card !bg-white/60 p-3 mt-4"> 
             <div class="flex gap-2">
                <input v-model="quickItinerary.time" type="time" class="ios-input !w-auto text-center !px-2 font-mono text-sm">
                <input v-model="quickItinerary.title" class="ios-input flex-1 text-sm" placeholder="Quick add...">
                <button @click="addQuickItinerary" class="w-10 bg-blue-500 text-white rounded-xl shadow-md flex items-center justify-center"><i class="ph ph-plus"></i></button>
             </div>
         </div>
      </div>

      <div v-if="currentTab === '記帳'" class="pb-20 animate-fade-in">
          <div class="bg-gray-200/50 p-1 rounded-xl flex mb-4 mx-1">
              <button v-for="f in ['all', 'credit', 'cash', 'settlement']" :key="f" @click="expenseFilter = f" 
                 class="flex-1 py-1.5 text-xs font-bold rounded-lg transition-all"
                 :class="expenseFilter === f ? 'bg-white shadow-sm text-black' : 'text-gray-500'">
                 {{ t(f === 'credit' ? 'credit' : f === 'settlement' ? 'settle' : f) }}
              </button>
          </div>

          <div v-if="expenseFilter === 'settlement'" class="space-y-3">
             <div v-for="s in settlementList" :key="s.name" class="ios-card bg-white p-4 flex justify-between items-center">
                 <div class="font-bold text-lg">{{ s.name }}</div>
                 <div class="text-right">
                     <div class="text-[10px] uppercase text-gray-400 font-bold mb-0.5">{{ s.amount >= 0 ? t('shouldReceive') : t('shouldPay') }}</div>
                     <div class="text-xl font-bold font-mono" :class="s.amount >= 0 ? 'text-green-500' : 'text-red-500'">{{ s.amount >= 0 ? '+' : '' }}{{ formatNumber(s.amount) }}</div>
                 </div>
             </div>
          </div>
          
          <div v-else class="space-y-2">
             <div v-for="e in filteredExpenses" :key="e.id" @click="openExpenseModal(e)" class="ios-list-item !items-start !flex-col !p-3 cursor-pointer">
                 <div class="w-full flex justify-between items-center mb-1.5">
                     <div class="flex items-center gap-2">
                         <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{{ t(e.category) }}</span>
                     </div>
                 </div>
                 <div class="w-full flex justify-between items-end pl-6">
                     <div class="font-bold text-xl text-blue-600"><span class="text-[10px] text-gray-500 mr-1">{{ e.currency }}</span>{{ formatNumber(e.amount) }}</div>
                     <div class="text-right">
                         <div class="font-bold text-gray-900">{{ e.name }}</div>
                         <div class="text-[10px] text-gray-400">{{ e.payer }} paid • {{ e.paymentMethod === 'credit_card' ? t('credit') : t('cash') }}</div>
                     </div>
                 </div>
             </div>
          </div>
      </div>

      <div v-if="currentTab === '設定'" class="animate-fade-in pb-24 fixed inset-0 bg-[#F2F2F7] z-50 flex flex-col">
           <div class="bg-white px-5 pt-12 pb-4 border-b border-gray-200 flex justify-between items-center">
               <button @click="cancelSettings" class="text-blue-500 font-medium">{{ t('cancel') }}</button>
               <span class="font-bold text-lg">{{ t('設定') }}</span>
               <button @click="saveSettings" class="text-blue-500 font-bold">{{ t('save') }}</button>
           </div>
           
           <div class="flex-1 overflow-y-auto p-5 space-y-6">
               <div class="ios-card p-5 space-y-4">
                 <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Route</label><input v-model="tempSettings.route" class="ios-input font-bold"></div>
                 <div class="grid grid-cols-2 gap-4">
                     <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Start</label><input v-model="tempSettings.startDate" type="date" class="ios-input"></div>
                     <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase">End</label><input v-model="tempSettings.endDate" type="date" class="ios-input"></div>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                     <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Local $</label><input v-model="tempSettings.localCurrency" class="ios-input font-mono uppercase"></div>
                     <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Home $</label><input v-model="tempSettings.homeCurrency" class="ios-input font-mono uppercase"></div>
                 </div>
                 <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Weather City</label><input v-model="tempSettings.weatherLoc" class="ios-input"></div>
                 <div><label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Info</label><textarea v-model="tempSettings.infoText" class="ios-input h-24"></textarea></div>
              </div>
              <div class="text-center text-xs text-gray-400 mt-4">{{ appVersion }}</div>
           </div>
      </div>

    </main>

    <nav class="fixed bottom-6 left-0 right-0 z-50 px-4 pointer-events-none">
      <div class="iphone-dock pointer-events-auto">
        <button v-for="t in ['首頁','行程','記帳']" :key="t" @click="currentTab=t" class="group flex flex-col items-center justify-center flex-1 transition-all text-gray-400" :class="{'!text-[#007AFF]': currentTab===t}">
            <i class="text-[28px] mb-1" :class="[currentTab===t ? 'ph-fill' : 'ph-bold', {'首頁':'ph-house','行程':'ph-map-trifold','記帳':'ph-wallet'}[t]]"></i>
            <span class="text-[10px] font-semibold">{{ t }}</span>
        </button>
        <button @click="enterSettings" class="group flex flex-col items-center justify-center flex-1 transition-all text-gray-400">
            <i class="text-[28px] mb-1 ph-bold ph-gear"></i>
            <span class="text-[10px] font-semibold">{{ t('設定') }}</span>
        </button>
      </div>
    </nav>
    
    <div v-if="expenseModalOpen" class="modal-backdrop" @click.self="expenseModalOpen=false">
        <div class="ios-modal-container">
            <div class="ios-modal-header">{{ newExpense.id ? t('edit') : t('new') }}</div>
            <div class="ios-modal-body space-y-3">
                 <div class="flex gap-2">
                     <select v-model="newExpense.currency" class="ios-input w-24 font-bold text-center"><option :value="settings.localCurrency">{{ settings.localCurrency }}</option><option :value="settings.homeCurrency">{{ settings.homeCurrency }}</option></select>
                     <input :value="newExpense.amount" readonly class="ios-input text-right font-bold text-2xl">
                 </div>
                 <div class="calc-grid">
                     <button v-for="b in ['7','8','9','/','4','5','6','*','1','2','3','-','C','0','.','+']" :key="b" @click="handleCalcInput(b)" class="calc-btn" :class="{'op': ['/','*','-','+','='].includes(b)}">{{ b }}</button>
                     <button @click="handleCalcInput('=')" class="calc-btn op">=</button>
                 </div>
                 <input v-model="newExpense.name" class="ios-input" placeholder="Description">
                 
                 <div class="grid grid-cols-4 gap-2">
                    <button v-for="cat in ['ticket','transport','shopping_cat','dining','entertainment','accommodation','service','other']" 
                        :key="cat" @click="newExpense.category=cat"
                        class="flex flex-col items-center p-2 rounded-xl border transition-all"
                        :class="newExpense.category===cat ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-transparent text-gray-400'">
                        <i class="ph-bold text-xl mb-1" :class="{'ticket':'ph-ticket','transport':'ph-train','shopping_cat':'ph-bag','dining':'ph-bowl-food','entertainment':'ph-popcorn','accommodation':'ph-bed','service':'ph-hand-heart','other':'ph-dots-three'}[cat]"></i>
                        <span class="text-[9px] font-bold">{{ t(cat) }}</span>
                    </button>
                 </div>

                 <div class="flex justify-between gap-2">
                     <select v-model="newExpense.payer" class="ios-input flex-1"><option v-for="m in members" :value="m">{{ m }}</option></select>
                     <div class="flex bg-gray-200/50 p-1 rounded-lg">
                         <button @click="newExpense.paymentMethod='cash'" class="px-3 rounded-md text-xs font-bold" :class="newExpense.paymentMethod==='cash' ? 'bg-white shadow' : 'text-gray-500'">{{ t('cash') }}</button>
                         <button @click="newExpense.paymentMethod='credit_card'" class="px-3 rounded-md text-xs font-bold" :class="newExpense.paymentMethod==='credit_card' ? 'bg-white shadow' : 'text-gray-500'">{{ t('credit') }}</button>
                     </div>
                 </div>
            </div>
            <div class="ios-modal-footer">
                <button v-if="newExpense.id" @click="removeExpense(newExpense.id); expenseModalOpen=false" class="btn-ios-danger">{{ t('delete') }}</button>
                <button @click="expenseModalOpen=false" class="btn-ios-cancel">{{ t('cancel') }}</button>
                <button @click="saveExpense" class="btn-ios-primary">{{ t('save') }}</button>
            </div>
        </div>
    </div>
    
    <div v-if="memberModalOpen" class="modal-backdrop" @click.self="memberModalOpen=false">
        <div class="ios-modal-container">
             <div class="ios-modal-header">Members</div>
             <div class="ios-modal-body space-y-3">
                 <div v-for="(m, idx) in members" :key="idx" class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm">
                     <span class="font-bold">{{ m }}</span>
                     <button v-if="members.length > 1" @click="removeMember(m)" class="text-red-500"><i class="ph-bold ph-trash"></i></button>
                 </div>
                 <div class="flex gap-2 mt-4">
                     <input v-model="newMemberName" class="ios-input" placeholder="New Name">
                     <button @click="addMember" class="bg-black text-white px-4 rounded-xl font-bold"><i class="ph-bold ph-plus"></i></button>
                 </div>
             </div>
             <div class="ios-modal-footer"><button @click="memberModalOpen=false" class="btn-ios-cancel">Done</button></div>
        </div>
    </div>

    <div v-if="shoppingModalOpen" class="modal-backdrop" @click.self="shoppingModalOpen=false"><div class="ios-modal-container"><div class="ios-modal-header">{{t('shopping')}}</div><div class="ios-modal-body space-y-4"><input v-model="newShoppingItem.name" class="ios-input" placeholder="Name"></div><div class="ios-modal-footer"><button v-if="newShoppingItem.id" @click="removeShoppingItem(newShoppingItem.id); shoppingModalOpen=false" class="btn-ios-danger">{{t('delete')}}</button><button @click="shoppingModalOpen=false" class="btn-ios-cancel">{{t('cancel')}}</button><button @click="saveShoppingItem" class="btn-ios-primary">{{t('save')}}</button></div></div></div>
    <div v-if="itineraryModalOpen" class="modal-backdrop" @click.self="itineraryModalOpen=false"><div class="ios-modal-container"><div class="ios-modal-header">{{t('edit')}}</div><div class="ios-modal-body space-y-3"><select v-model="newItineraryItem.dayIndex" class="ios-input"><option v-for="(d, i) in days" :key="i" :value="i">Day {{ i + 1 }}</option></select><input type="time" v-model="newItineraryItem.time" class="ios-input"><input v-model="newItineraryItem.title" class="ios-input" placeholder="Title"></div><div class="ios-modal-footer"><button @click="itineraryModalOpen=false" class="btn-ios-cancel">{{t('cancel')}}</button><button @click="saveItineraryItem" class="btn-ios-primary">{{t('save')}}</button></div></div></div>
    <div v-if="flightModalOpen" class="modal-backdrop" @click.self="flightModalOpen=false"><div class="ios-modal-container"><div class="ios-modal-header">Flight</div><div class="ios-modal-body space-y-3"><input v-model="newFlight.code" class="ios-input" placeholder="CX400"><div class="flex gap-2"><input v-model="newFlight.fromCode" class="ios-input"><input v-model="newFlight.toCode" class="ios-input"></div><div class="flex gap-2"><input v-model="newFlight.depTime" type="time" class="ios-input"><input v-model="newFlight.arrTime" type="time" class="ios-input"></div></div><div class="ios-modal-footer"><button @click="flightModalOpen=false" class="btn-ios-cancel">{{t('cancel')}}</button><button @click="saveFlight" class="btn-ios-primary">{{t('save')}}</button></div></div></div>

  </div>
</body>
</html>
